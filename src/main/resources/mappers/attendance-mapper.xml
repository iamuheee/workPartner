<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="attendanceMapper">
	
	<resultMap id="AttendanceResult" type="Attendance">
		<result column="ATT_NO" property="attNo"/>
		<result column="EMP_NO" property="empNo"/>
		<result column="ATT_DATE" property="attDate"/>
		<result column="ATT_FCMT" property="attFcmt"/>
		<result column="ATT_FQT" property="attFqt"/>
		<result column="ATT_CMT" property="attCmt"/>
		<result column="ATT_QT" property="attQt"/>
		<result column="ATT_TIME" property="attTime"/>
		<result column="ATT_WORKHOURS" property="attWorkhours"/>
		<result column="ATT_STATUS" property="status"/>
		<result column="ATT_HOLIDAY" property="hollyday"/>
		
		<result column="DEP_NAME" property="depName"/>
		<result column="POS_NAME" property="posName"/>
		<result column="EMP_NAME" property="empName"/>
		<result column="ATT_WORKHOURS" property="workhours"/>
		<result column="dt" property="dt"/>
		<result column="emp_status" property="empStatus"/>
		
		<result column="work_week" property="workWeek"/>
		<result column="work_month" property="workMonth"/>
		<result column="week_work_hours" property="weekWorkHours"/>
		<result column="week_plus_work_hours" property="weekPlusWorkHours"/>
		<result column="month_work_hours" property="monthWorkHours"/>
		<result column="month_plus_work_hours" property="monthPlusWorkHours"/>
		<result column="x" property="x"/>
		<result column="y" property="y"/>
		
	</resultMap>
	
	<resultMap id="departmentResult" type="AttDepartment">
		<result column="dep_cd" property="depCd"/>
		<result column="dep_name" property="depName"/>
	</resultMap>
	
	<resultMap id="positionResult" type="AttPosition">
		<result column="POS_CD" property="posCd"/>
		<result column="POS_NAME" property="posName"/>
		<result column="workYears" property="workYears"/>
	</resultMap>
	
	<resultMap id="holidayResult" type="Holiday">
		<result column="hol1_day" property="holDay"/>
		<result column="hol1_name" property="holName"/>
	</resultMap>
	
	<resultMap id="vacationResult" type="AttVacation">
		<result column="a" property="a"/>
		<result column="b" property="b"/>
		<result column="c" property="c"/>
		<result column="d" property="d"/>
		<result column="e" property="e"/>
		<result column="f" property="f"/>
		<result column="g" property="g"/>
		<result column="h" property="h"/>
		<result column="i" property="i"/>
	</resultMap>
	
	
	<!-- 전사원 근태현황 조회 리스트개수 -->
	<select id="selectSearchCount" resultType="_int">
		select count(*)
			from (SELECT 
			        c.emp_no,
			        d.dep_name,
			        d.dep_cd,
			        p.pos_name,
			        e.emp_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        a.att_time,
			        e.emp_status,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        
			        	<choose>
							<when test='condition == "0"'></when>
							<otherwise> 
							   	and dep_cd = #{condition}
							</otherwise>
						</choose>
						
						<if test="keyword != null and keyword != ''">
					    and (emp_name like '%' || #{keyword} || '%' or emp_no = #{keyword})
					   	</if>
					order by dt desc, dep_name
	    
	</select>
	
	<!-- 전사원 근태현황 조회 리스트-->
	<select id="selectSearchList" resultMap="AttendanceResult">
		select *
			from (SELECT 
			        c.emp_no,
			        d.dep_name,
			        d.dep_cd,
			        p.pos_name,
			        e.emp_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        case when a.att_time is not null
			        	then (trunc(a.att_time/60) || '시간' || trunc(((a.att_time/60)-trunc(a.att_time/60))*60) || '분') 
			        	else null end as att_time,
			        e.emp_status,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        
			        	<choose>
							<when test='condition == "0"'></when>
							<otherwise> 
							   	and dep_cd = #{condition}
							</otherwise>
						</choose>
						
						<if test="keyword != null and keyword != ''">
					    and (emp_name like '%' || #{keyword} || '%' or emp_no = #{keyword})
					   	</if>
					order by dt desc, dep_name
	    
	</select>
	
	
	<!-- 전사원 근태현황 조회 근무상태 수 -->
	<select id="statusCount" resultType="_int">

		select count(*)
			from (SELECT 
			        c.emp_no,
			        d.dep_name,
			        d.dep_cd,
			        p.pos_name,
			        e.emp_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        a.att_time,
			        e.emp_status,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        
			        	<choose>
							<when test='condition == "0"'></when>
							<otherwise> 
							   	and dep_cd = #{condition}
							</otherwise>
						</choose>
						
						<if test="keyword != null and keyword != ''">
					    and (emp_name like '%' || #{keyword} || '%' or emp_no = #{keyword})
					   	</if>
					 and att_status = #{a}
					order by dt desc, dep_name
          

	</select>
	
	<select id="departmentList" resultMap="departmentResult">
		select 
				dep_cd
			  , dep_name
			from tb_department 
			order 
			   by dep_cd 
	</select>
	
	<select id="positionList" resultMap="positionResult">
		 select 
				pos_cd
			  ,	pos_name
		   from tb_position
		   order 
			   by pos_cd
	</select>
	
	<insert id="insertPosition">
		insert 
			into tb_position
				(
					pos_cd
				  , pos_name
				)
				values
				(
					#{positionCode}
				  , #{positionName}
				)	
	</insert>
	
	<insert id="insertDepartment">
		insert 
			into tb_department
				(
					dep_cd
				  , dep_name
				)
				values
				(
					#{departmentCode}
				  , #{departmentName}
				)	
	</insert>
	
	<update id="updatePosition">
		update tb_position
			set 
				pos_cd = #{positionCode2}
			   ,pos_name = #{positionName2}
			where pos_cd = #{positionCode1}
			  and pos_name = #{positionName1}
	</update>
	
	<delete id="deletePosition">
		delete 
			from tb_position
		   where pos_cd = #{positionCode1}
	</delete>
	
	
	<update id="updateDepartment">
		update tb_department
			set 
				dep_cd = #{departmentCode2}
			   ,dep_name = #{departmentName2}
			where dep_cd = #{departmentCode1}
			  and dep_name = #{departmentName1}
	</update>
	
	<delete id="deleteDepartment">
		delete 
			from tb_department
		   where dep_cd = #{departmentCode1}
	</delete>
	
	
	<select id="holidayList" resultMap="holidayResult">
		select 
				hol1_day
			  , hol1_name
			from tb_holiday1 
			order 
			   by hol1_day 
	</select>
	
	<insert id="insertHoliday">
		insert 
			into tb_holiday1
				(
					hol1_day
				  , hol1_name
				)
				values
				(
					#{holidayCode}
				  , #{holidayName}
				)	
	</insert>
	
	<update id="updateHoliday">
		update tb_holiday1
			set 
				hol1_day = #{holidayCode2}
			   ,hol1_name = #{holidayName2}
			where hol1_day = #{holidayCode1}
			  and hol1_name = #{holidayName1}
	</update>
	
	<delete id="deleteHoliday">
		delete 
			from tb_holiday1
		   where hol1_day = #{holidayCode1}
	</delete>
	
	
	<!-- 내 근무내역 개수 -->
	<select id="myAttendanceCount" resultType="_int">
		select count(*)
			from (SELECT 
			        c.emp_no,
			        d.dep_name,
			        d.dep_cd,
			        p.pos_name,
			        e.emp_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        a.att_time,
			        e.emp_status,
			        (select to_char(trunc(sysdate,'iw'), 'mm.dd(dy)') || '~' || to_char(trunc(sysdate,'iw')+4, 'mm.dd(dy)') from dual) as work_week,
                    (select to_char(sysdate, 'yyyy.mm') from dual) as work_month,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_plus_work_hours,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_plus_work_hours,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        	
			        	<if test="id != null and id != ''">
			        		and emp_no = #{id}
			        	</if>
			        	
			        	<if test="array.length >= 1">
					    AND att_status IN
					    <foreach collection="array" item="item" index="index"  open="(" close=")" separator=",">
			        	  #{item}
   						 </foreach>
   						 </if>
					order by dt desc
	    
	</select>
	
	
	
	<!-- 내근무내역 조회 리스트-->
	<select id="myAttendanceList" resultMap="AttendanceResult">
		select *
			from (SELECT 
					(select 52 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as x,
                    (select 225 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as y,    
			        c.emp_no,
			        d.dep_name,
			        p.pos_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        case when a.att_time is not null
			        	then (trunc(a.att_time/60) || '시간' || trunc(((a.att_time/60)-trunc(a.att_time/60))*60) || '분') 
			        	else null end as att_time,
			        e.emp_status,
			        (select to_char(trunc(sysdate,'iw'), 'mm.dd(dy)') || '~' || to_char(trunc(sysdate,'iw')+4, 'mm.dd(dy)') from dual) as work_week,
                    (select to_char(sysdate, 'yyyy.mm') from dual) as work_month,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_plus_work_hours,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_plus_work_hours,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        	
			        	<if test="id != null and id != ''">
			        		and emp_no = #{id}
			        	</if>
			        	
			        	
			        	<if test="array.length >= 1">
					    AND att_status IN
					    <foreach collection="array" item="item" index="index"  open="(" close=")" separator=",">
			        	  #{item}
   						 </foreach>
   						 </if>
   						 
			        	
					order by dt desc
	    
	</select>
	
	
	<!-- 내 근무내역 개수 -->
	<select id="myAttendanceCount2" resultType="_int">
		select count(*)
			from (SELECT 
			        c.emp_no,
			        d.dep_name,
			        d.dep_cd,
			        p.pos_name,
			        e.emp_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        a.att_time,
			        e.emp_status,
			        (select to_char(trunc(sysdate,'iw'), 'mm.dd(dy)') || '~' || to_char(trunc(sysdate,'iw')+4, 'mm.dd(dy)') from dual) as work_week,
                    (select to_char(sysdate, 'yyyy.mm') from dual) as work_month,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as week_plus_work_hours,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')) as month_plus_work_hours,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        	
			        	<if test="id != null and id != ''">
			        		and emp_no = #{id}
			        	</if>
			        	
					order by dt desc
	    
	</select>
	
	
	
	<!-- 내근무내역 조회 리스트-->
	<select id="myAttendanceList2" resultMap="AttendanceResult">
		select *
			from (SELECT 
					(select 52 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as x,
                    (select 225 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id} ) as y,    
			        c.emp_no,
			        d.dep_name,
			        p.pos_name,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        case when a.att_time is not null
			        	then (trunc(a.att_time/60) || '시간' || trunc(((a.att_time/60)-trunc(a.att_time/60))*60) || '분') 
			        	else null end as att_time,
			        e.emp_status,
			        (select to_char(trunc(sysdate,'iw'), 'mm.dd(dy)') || '~' || to_char(trunc(sysdate,'iw')+4, 'mm.dd(dy)') from dual) as work_week,
                    (select to_char(sysdate, 'yyyy.mm') from dual) as work_month,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as week_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as week_plus_work_hours,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as month_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as month_plus_work_hours,
			        case when a.att_qt is not null  
			             then trunc((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24)||'시간'||
			                 trunc(((to_date(a.att_qt, 'hh24mi')-to_date(a.att_cmt, 'hh24mi'))*24-(trunc((to_date(a.att_qt, 'hh24mi')
			                        -to_date(a.att_cmt, 'hh24mi'))*24)))*60)||'분'
			             else null 
			        end as att_workhours,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			<choose>
													 	<when test="(date1 != null and date1 != '') and (date2 != null and date2 != '')">
											            	SELECT TO_CHAR(TO_DATE(#{date1},'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(#{date2},'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											            </when>
											           	<otherwise>
											           		SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01' AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											            </otherwise>
													</choose>
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
			        	
			        	<if test="id != null and id != ''">
			        		and emp_no = #{id}
			        	</if>
			        	
 
			        	
					order by dt desc
	    
	</select>
	
	
	
	
	<select id="badWorkList" resultMap="AttendanceResult">
		select *
			from (SELECT 
			        c.emp_no,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        e.emp_status,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			
											            	SELECT TO_CHAR(TO_DATE(20220101,'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											      
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
					and att_status = '결근'	
					and emp_no = #{empNo}
					  
	</select>
	
	<select id="goodWorkList" resultMap="AttendanceResult">
		select *
			from (SELECT 
			        c.emp_no,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        e.emp_status,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			
											            	SELECT TO_CHAR(TO_DATE(20220101,'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											      
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
					  and att_status = '정상'	
					  and emp_no = #{empNo}
					  
	</select>
	
	
	<select id="vacationWorkList" resultMap="AttendanceResult">
		select *
			from (SELECT 
			        c.emp_no,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        e.emp_status,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			
											            	SELECT TO_CHAR(TO_DATE(20220101,'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(TO_DATE(20231230,'YYYY-MM-DD'), 'YYYYMMDD') AS END_DT
											      
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
					  and (att_status = '연차' or att_status = '오전반차' or att_status = '오후반차')	
					  and emp_no = #{empNo}
					  
	</select>
	
	
	
	<select id="bad2WorkList" resultMap="AttendanceResult">
		select *
			from (SELECT 
			        c.emp_no,
			        c.dt,
			        a.att_cmt,
			        a.att_qt,
			        e.emp_status,
			        case when a.att_status is null 
			             then '결근'
			             else a.att_status
			             end as att_status
				    FROM
				        tb_attendance a 
				    right
				     join (SELECT DT, EMP_NO
				              FROM (
				                        SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT,
				                               TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'D') AS DAY
				                           FROM ( 
				                           			
											            	SELECT TO_CHAR(TO_DATE(20220101,'YYYY-MM-DD'), 'YYYYMMDD') AS ST_DT 
			                                              , 	   TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT
											      
				                                    FROM DUAL 
				                                  )
				                         CONNECT BY LEVEL <![CDATA[<=]]> TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
				                    ), (SELECT EMP_NO FROM TB_EMPLOYEE)
				                WHERE DAY NOT IN (1, 7)
				                AND DT NOT IN (select hol1_day from tb_holiday1)
				            )c on (a.emp_no = c.emp_no and a.att_date = c.dt)
			        join tb_employee e
				      on (c.emp_no = e.emp_no)
				    join tb_position p
				      on (e.pos_cd = p.pos_cd)
				    join tb_department d
				      on (e.dep_cd = d.dep_cd))
			        where emp_status='Y'
					and(att_status = '지각' or att_status = '조퇴')	
					and emp_no = #{empNo}
					  
	</select>
	
	<select id="timeSelect" resultMap="AttendanceResult">
		
		select to_char(to_date(ATT_CMT,'hh24:mi'), 'hh24 : mi') as att_cmt, 
			   to_char(to_date(ATT_qt,'hh24:mi'), 'hh24 : mi') as att_qt 
		from tb_attendance
		where emp_no = #{empNo}
		and att_date = to_char(sysdate, 'yyyymmdd')
	
	</select>
	
	<select id="checkHoliday" resultMap="AttendanceResult">
		
		SELECT att_holiday
		    FROM
		    (
		         SELECT CASE WHEN C.DT = ( SELECT TO_CHAR(SYSDATE,'YYYYMMDD') FROM DUAL) THEN 'Y' ELSE 'N' END AS att_holiday
		           FROM (
		                    SELECT	B.DT
		                    FROM
		                    (
		                        SELECT  TO_CHAR(TO_DATE(A.DT),'D') AS D
		                            ,	A.DT
		                         FROM (
		                                     SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT
		                                       FROM ( 
		                                                SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01'  AS ST_DT 
		                                                     , TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD') AS END_DT 
		                                                FROM DUAL 
		                                              )
		                                     CONNECT BY LEVEL <![CDATA[<=]]>  TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
		                              ) A
		                    ) B
		                    WHERE B.D NOT IN ('1','7')
		                    AND B.DT NOT IN 
		                  
		                    ( 
		                       SELECT HOL1_DAY FROM TB_HOLIDAY1
		                        
		                        union 
		                    
		                        select ATT_DATE
		                            from tb_attendance
		                            where emp_no = #{empNo}
		                              and att_status = '연차'
		                       
		                    )
		                    
		                    
		             )C
		     )
	</select>
	
	
	<update id="goWorkCheck">
		MERGE 
		 INTO TB_ATTENDANCE A 
		USING ( SELECT #{empNo} AS EMP_NO
		            ,   TO_CHAR(SYSDATE,'YYYYMMDD') AS ATT_DATE
		            ,   TO_CHAR(SYSDATE,'HH24MI') AS ATT_TIME
		          FROM DUAL
		        ) B
		   ON (A.EMP_NO = B.EMP_NO
		     AND A.ATT_DATE = B.ATT_DATE
		   )
		 WHEN MATCHED THEN
		      UPDATE
		         SET A.ATT_CMT = B.ATT_TIME
		        ,   A.ATT_STATUS = (SELECT CASE WHEN (TO_DATE(B.ATT_DATE||A.ATT_FCMT, 'yyyymmddhh24mi') + 10/24/60) <![CDATA[<]]> SYSDATE THEN '지각' ELSE '정상' END FROM DUAL )
		 WHEN NOT MATCHED THEN
		       INSERT 
		      (
		                ATT_NO
		            ,   EMP_NO
		            ,   ATT_DATE
		            ,   ATT_FQT
		            ,   ATT_FCMT
		            ,   ATT_CMT
		            ,   ATT_STATUS
		            ,   ATT_HOLIDAY
		            )
		      VALUES(
		         SEQ_ATTNO.NEXTVAL 
		      ,  B.EMP_NO
		      ,  B.ATT_DATE
		      , '1800'
		      , '0900'
		      , TO_CHAR(SYSDATE,'HH24MI')
		      , (SELECT CASE WHEN (TO_DATE(TO_CHAR(SYSDATE,'YYYYMMDD')||'0900', 'yyyymmddhh24mi') + 10/24/60) <![CDATA[<]]> SYSDATE THEN '지각' ELSE '정상' END FROM DUAL )
		      , 'N'
		      )
	</update>	
	
	
	<update id="outWorkCheck">
		
		UPDATE TB_ATTENDANCE
		          SET ATT_QT = (SELECT TO_CHAR(SYSDATE,'HH24MI') FROM DUAL)
		        , ATT_STATUS = (SELECT CASE WHEN (TO_DATE((SELECT TO_CHAR(SYSDATE,'YYYYMMDD') FROM DUAL)||
                (SELECT ATT_FQT FROM TB_ATTENDANCE WHERE EMP_NO = #{empNo} AND ATT_DATE = TO_CHAR(SYSDATE, 'YYYYMMDD')), 'yyyymmddhh24mi')) > SYSDATE THEN '조퇴' ELSE ATT_STATUS END FROM DUAL )
                , ATT_TIME = (case when (select to_char(sysdate, 'hh24mi') from dual) > att_fqt 
				            then trunc((to_date(to_char(sysdate, 'hh24mi'), 'hh24mi') - to_date(att_fqt, 'hh24mi'))*24*60)  
				            else null end),
				ATT_WORKHOURS = trunc((to_date(to_char(sysdate, 'hh24mi'), 'hh24mi') - to_date(att_cmt, 'hh24mi'))*24*60)
		  where emp_no = #{empNo}
		  and att_date = (SELECT TO_CHAR(SYSDATE,'yyyymmdd') FROM DUAL)      
	</update>
	
	
	<select id="checkMonth" resultMap="AttendanceResult">
	
	SELECT att_holiday
	    FROM
	    (
	         SELECT CASE WHEN  TO_CHAR(SYSDATE,'YYYYMMDD') = MAX(C.DT) THEN 'Y' ELSE 'N' END AS att_holiday
	           FROM (
	                    SELECT	B.DT
	                    FROM
	                    (
	                        SELECT  TO_CHAR(TO_DATE(A.DT),'D') AS D
	                            ,	A.DT
	                         FROM (
	                                     SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT
	                                       FROM ( 
	                                                SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01'  AS ST_DT 
	                                                     , TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD') AS END_DT 
	                                                FROM DUAL 
	                                              )
	                                     CONNECT BY LEVEL <![CDATA[<=]]>  TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
	                              ) A
	                    ) B
	                    WHERE B.D NOT IN ('1','7')
	                    AND B.DT NOT IN 
	                  
	                    ( 
	                       SELECT HOL1_DAY FROM TB_HOLIDAY1
	                        
	                        union 
	                    
	                        select ATT_DATE
	                            from tb_attendance
	                            where emp_no = #{empNo}
	                              and att_status = '연차'
	                       
	                    )
	                    
	                    
	             )C
	     )
	     
	</select>
	
	<select id="checkWorkYears" resultType="String">
		select trunc((sysdate-to_date(EMP_ENROLLDATE,'yyyy-mm-dd')+1)/365) as workYears
		from tb_employee
		where emp_no = #{empNo}
	</select>
	
	
	
	<select id="checkWorkStatus" resultMap="AttendanceResult">
		
		 SELECT B.DT,
		        NVL(B.ATT_STATUS,'결근') AS ATT_STATUS
		 FROM
		     (SELECT  A.DT,
		     to_char(TO_DATE(a.DT),'d') d
        ,   (SELECT CASE WHEN att_status = '연차' THEN '연차'
                         WHEN att_status = '조퇴' THEN '조퇴'
                         WHEN att_status = '지각' THEN '지각'
                         WHEN att_status = '정상' THEN '정상'
                         WHEN att_status = '결근' THEN '결근'
                         END
                         
               FROM tb_attendance 
              WHERE ATT_DATE = A.DT
                and EMP_NO = #{empNo}) AS ATT_status
                    
			     FROM (
			                  SELECT TO_CHAR(TO_DATE(ST_DT, 'YYYYMMDD') + LEVEL - 1, 'YYYYMMDD') AS DT
			                   FROM ( 
			                            SELECT TO_CHAR(SYSDATE,'YYYYMM')||'01'  AS ST_DT 
			                                 , TO_CHAR(SYSDATE,'YYYYMMDD') AS END_DT 
			                            FROM DUAL 
			                          )
			                 CONNECT BY LEVEL <![CDATA[<=]]>  TO_DATE(END_DT, 'YYYYMMDD') - TO_DATE(ST_DT, 'YYYYMMDD') + 1
			          ) A
				)B
				where dt not in(select hol1_day from tb_holiday1)
				and d NOT IN ('1','7')
				
    
	</select>
	
	
	
	<insert id="giveVacation0">
		
		INSERT INTO tb_holiday2 (
		    hol2_no,
		    emp_no,
		    hol2_occurday,
		    hol2_expireday,
		    hol2_occurno
		) VALUES (
		    seq_holno.nextval,
		    #{empNo},
		    to_char(sysdate, 'YYYY-MM-DD'),
		    (to_char(sysdate,'YYYY')||'-12-31'),
		    '1'
		)

	</insert>
	
	<insert id="giveVacation00">
		
		INSERT INTO tb_holiday2 (
		    hol2_no,
		    emp_no,
		    hol2_occurday,
		    hol2_expireday,
		    hol2_occurno
		) VALUES (
		    seq_holno.nextval,
		    #{empNo},
		    to_char(sysdate, 'YYYY-MM-DD'),
		    (to_char(sysdate+(INTERVAL '1' YEAR),'YYYY')||'-12-31'),
		    '1'
		)

	</insert>
	
	
	<insert id="giveVacation1">
	
		INSERT INTO tb_holiday2 (
		    hol2_no,
		    emp_no,
		    hol2_occurday,
		    hol2_expireday,
		    hol2_occurno
		) VALUES (
		    seq_holno.nextval,
		    #{empNo},
		    to_char(sysdate, 'YYYY-MM-DD'),
		    (to_char(sysdate+(INTERVAL '1' YEAR),'YYYY')||'-12-31'),
		    (select trunc((sysdate-to_date(EMP_ENROLLDATE,'yyyy-mm-dd')+1)/365)+14 from tb_employee where emp_no = #{empNo})
		)
		
	</insert>
	
	
	<update id="plusVacation0">
		UPDATE tb_employee
			SET
			    EMP_HOLTAKE = EMP_HOLTAKE + 1 
			WHERE
        emp_no = #{empNo}
	</update>
	
	
	<update id="plusVacation1">
		UPDATE tb_employee
			SET
			    EMP_HOLTAKE = EMP_HOLTAKE + (
			                                select trunc((sysdate-to_date(EMP_ENROLLDATE,'yyyy-mm-dd')+1)/365)+14
			                                 from tb_employee where emp_no = #{empNo})
			WHERE
			        emp_no = #{empNo}
	</update>
	
	
	<select id="vacationCount" resultType="_int">
	
		select count(*)
		from
		(
			select emp_no a
		    , dep_name b
		    , pos_name c
		    , emp_name d
		    , emp_holtake e
		    , emp_holuse f
		    , (emp_holtake - emp_holuse) g
		    , emp_enrolldate h
		    , trunc((sysdate-to_date(EMP_ENROLLDATE,'yyyy-mm-dd')+1)/365) i
		    , dep_cd
            , emp_name
		from tb_employee
		join tb_department using (dep_cd)
		join tb_position using (pos_cd)
		where to_date(emp_enrolldate, 'yyyy-mm-dd') <![CDATA[<=]]>  to_date('2100-12-30', 'yyyy-mm-dd')
		<choose>
			<when test='condition == "0"'></when>
			<otherwise> 
			   	and dep_cd = #{condition}
			</otherwise>
		</choose>
		
		<if test="keyword != null and keyword != ''">
	    and (emp_name like '%' || #{keyword} || '%' or emp_no = #{keyword})
	   	</if>
		)
		

	</select>
	
	<select id="vacationList" resultMap="vacationResult">
	
			select emp_no a
		    , dep_name b
		    , pos_name c
		    , emp_name d
		    , emp_holtake e
		    , emp_holuse f
		    , (emp_holtake - emp_holuse) g
		    , emp_enrolldate h
		    , trunc((sysdate-to_date(EMP_ENROLLDATE,'yyyy-mm-dd')+1)/365) i
		    , dep_cd
            , emp_name
		from tb_employee
		join tb_department using (dep_cd)
		join tb_position using (pos_cd)
		where to_date(emp_enrolldate, 'yyyy-mm-dd') <![CDATA[<=]]>  to_date('21001230', 'yyyy-mm-dd')
			
			
			<choose>
			<when test='condition == "0"'></when>
			<otherwise> 
			   	and dep_cd = #{condition}
			</otherwise>
			</choose>
			
			<if test="keyword != null and keyword != ''">
		    and (emp_name like '%' || #{keyword} || '%' or emp_no = #{keyword})
		   	</if>
			
	</select>
	
	<select id="myAttendanceList3" resultMap="AttendanceResult">
		select (select 52 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as x,
                    (select 225 - trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id} ) as y,   
                (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as week_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date(to_char(trunc(sysdate,'iw')+4, 'yyyymmdd'), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date(to_char(trunc(sysdate,'iw'), 'yyyymmdd'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as week_plus_work_hours,
                    (select trunc(sum(ATT_WORKHOURS)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as month_work_hours,
                    (select trunc(sum(ATT_TIME)/60) from tb_attendance
                      where to_date((TO_CHAR(LAST_DAY(SYSDATE),'YYYYMMDD')), 'yyyymmdd') <![CDATA[>=]]> to_date(att_date, 'yyyymmdd')
                        and to_date((TO_CHAR(SYSDATE,'YYYYMM')||'01'), 'yyyymmdd') <![CDATA[<=]]> to_date(att_date, 'yyyymmdd')
                        and emp_no = #{id}) as month_plus_work_hours
          from tb_attendance        
		
	</select>
	
	
	<select id="myVacationList" resultMap="vacationResult">
	
		select EMP_HOLTAKE a,
			EMP_HOLUSE b,
			(emp_holtake - emp_holuse)c
		from tb_employee
		where emp_no = #{empNo}
		
	</select>
	
	<select id="myVacationList2" resultMap="vacationResult">
	
		select HOL2_OCCURDAY a,
				HOL2_EXPIREDAY b,
				HOL2_OCCURNO c,
				(case when HOL2_OCCURNO = '1' then '월차' else '연차' end) d
			from tb_holiday2
			where emp_no = #{empNo}
			order by a desc
		
	</select>
	
	<select id="myVacationList3" resultMap="vacationResult">
	
		select to_char(to_date(va_create, 'yyyymmdd'), 'yyyy-mm-dd') a,
				va_category b,
				case when va_useday = '0.5' then to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd')
				     when va_useday = '1' then to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd')
				     else to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd') || '~' || to_char(to_date(va_end, 'yyyymmdd'), 'yyyy-mm-dd')
				     end c,
				va_useday d,
				va_status e
				from vacation
		where emp_no = #{empNo}
		order by a desc


	</select>
	
	<select id="myVacationCount" resultType="_int">
		
		select count(*)
		from
		(
		select to_char(to_date(va_create, 'yyyymmdd'), 'yyyy-mm-dd') a,
				va_category b,
				case when va_useday = '0.5' then to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd')
				     when va_useday = '1' then to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd')
				     else to_char(to_date(va_start, 'yyyymmdd'), 'yyyy-mm-dd') || '~' || to_char(to_date(va_end, 'yyyymmdd'), 'yyyy-mm-dd')
				     end c,
				va_useday d,
				va_status e
				from vacation
		where emp_no = #{empNo}
		)
	</select>
	
	<update id="resetVacation">
	
		UPDATE tb_employee
			SET
			    emp_holtake = '0',
			    emp_holuse = '0'
			WHERE
			    emp_no = #{empNo}
		
	</update>
	
	
	<select id="changeAttendanceTime" resultMap="vacationResult">
	
		select ATT_CMT as a, ATT_QT as b
		from tb_attendance
		where emp_no = #{empNo}
		and ATT_DATE = to_char(to_date(#{time}, 'YYYY-MM-DD'), 'yyyymmdd')
		
	</select>
	
	
	<insert id="changeAttendanceTime2">

        
		INSERT INTO tb_adjust_attendance (
		    aat_no,
		    emp_no,
		    aat_fcmt,
		    aat_fqt,
		    aat_ajfcmt,
		    aat_ajfqt,
		    aat_date,
		    aat_writeday,
		    aat_title,
		    aat_reason,
		    aat_status,
		    aat_time
		) VALUES (
		    SEQ_AATNO.nextval,
		    #{empNo},
		    #{text2},
		    #{text3},
		    #{text4},
		    #{text5},
		    to_char(to_date(#{text1}, 'YYYY-MM-DD'), 'yyyymmdd'),
		    to_char(current_date, 'yyyymmdd'),
		    '출퇴근 시간 변경',
		    #{text6},
		    '1',
		    '조정중'
		)
	</insert>
	
	
	<insert id="changeAttendanceTime3">

        
		INSERT INTO tb_adjust_attendance (
		    aat_no,
		    emp_no,
		    aat_fcmt,
		    aat_fqt,
		    aat_ajfcmt,
		    aat_ajfqt,
		    aat_date,
		    aat_writeday,
		    aat_title,
		    aat_reason,
		    aat_status,
		    aat_time
		) VALUES (
		    SEQ_AATNO.nextval,
		    #{empNo},
		    '0900',
		    '1800',
		    #{text44},
		    #{text55},
		    to_char(to_date(#{text11}, 'YYYY-MM-DD'), 'yyyymmdd'),
		    to_char(current_date, 'yyyymmdd'),
		    '근무시간 변경',
		    #{text66},
		    '2',
		    '조정중'
		)
		
	</insert>
	
	<select id="adminAttAdjust" resultMap="vacationResult">
	
		select
		    aat_no a,
		    aat_date b,
		    dep_name c,
		    emp_name d,
		    case when aat_status = '1' then '출퇴근 시간 변경'
		         else '근무시간 변경' end e,
		    aat_time f
		from  tb_adjust_attendance 
		join tb_employee using(emp_no)
		join tb_department using(dep_cd)
		where aat_status = '1'
			<if test="empNo != null and empNo != ''">
			    and emp_no = #{empNo}
		   	</if>
		order by a desc
		
	</select>
	
	<select id="adminAttAdjust2" resultMap="vacationResult">
	
		select
		    aat_no a,
		    aat_date b,
		    dep_name c,
		    emp_name d,
		    case when aat_status = '1' then '출퇴근 시간 변경'
		         else '근무시간 변경' end e,
		    aat_time f
		from  tb_adjust_attendance 
		join tb_employee using(emp_no)
		join tb_department using(dep_cd)
		where aat_status = '2'
			<if test="empNo != null and empNo != ''">
			    and emp_no = #{empNo}
		   	</if>
		order by a desc
		
	</select>
	
	<update id="agreeModify">
	
		update tb_attendance a
		  set (a.att_cmt 
		     , a.att_qt  
		     , a.att_status)
		     = (select aat_ajfcmt
		             , aat_ajfqt
		             , '정상'
		         from TB_ADJUST_ATTENDANCE b
		         where aat_no= #{aatNo})
		  where a.att_date = #{date}
		  and a.emp_no = (select emp_no
		                    from tb_employee
		                    where emp_name=#{empName})
	</update>
	
	<update id="paperModify">
		update TB_ADJUST_ATTENDANCE
                       set aat_time = '승인'
                    where aat_no = #{aatNo}
	</update>
	
	<update id="paperModify2">
		update TB_ADJUST_ATTENDANCE
                       set aat_time = '반려'
                    where aat_no = #{aatNo}
	</update>
	
	<insert id="paperModify3">
		insert 
		    into TB_ATTENDANCE
		    (
		        att_no,
		        emp_no,
		        att_date,
		        att_fcmt,
		        att_fqt
		    )
		    (
		    select 
		          seq_attno.nextval
		        , emp_no
		        , AAT_DATE
		        , AAT_AJFCMT
		        , AAT_AJFQT
		    from TB_ADJUST_ATTENDANCE
		    where aat_no = #{aatNo}
		    )
	</insert>
	
	<delete id="cancelModify">
		DELETE from TB_ADJUST_ATTENDANCE
		WHERE aat_no = #{aatNo}
	</delete>
	
	
	<select id="detail" resultMap="vacationResult">
	
		select 
			aat_date a,
			aat_fcmt b,
			aat_fqt c,
			AAT_AJFCMT d,
			AAT_AJFQT e,
			AAT_REASON f
		from TB_ADJUST_ATTENDANCE
		where aat_no = #{aatNo}
		
	</select>
	
	
</mapper>